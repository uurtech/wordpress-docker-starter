jQuery(function(n){var o=n("#woocommerce-order-items"),i=!1,c={handle_events:function(){o.on("click","button.configure_composite",{action:"configure"},this.clicked_edit_button).on("click","button.edit_composite",{action:"edit"},this.clicked_edit_button)},clicked_edit_button:function(e){var t=n.WCBackboneModal.View.extend({addButton:c.clicked_done_button}),o=n(this).closest("tr.item").attr("data-order_item_id");return i=new t({target:"wc-modal-edit-composite",string:{action:"configure"===e.data.action?wc_composite_admin_order_params.i18n_configure:wc_composite_admin_order_params.i18n_edit,item_id:o}}),c.populate_form(),!1},clicked_done_button:function(t){c.block(i.$el.find(".wc-backbone-modal-content"));var e=n.extend({},c.get_taxable_address(),{action:"woocommerce_edit_composite_in_order",item_id:i._string.item_id,fields:i.$el.find("input, select, textarea").serialize(),dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:wc_composite_admin_order_params.edit_composite_nonce});n.post(woocommerce_admin_meta_boxes.ajax_url,e,function(e){e.result&&"success"===e.result?(o.find(".inside").empty(),o.find(".inside").append(e.html),"yes"===wc_composite_admin_order_params.is_wc_version_gte_3_4?o.trigger("wc_order_items_reloaded"):(c.core.init_tiptip(),c.core.stupidtable.init()),"yes"===wc_composite_admin_order_params.is_wc_version_gte_3_6&&e.notes_html&&(n("ul.order_notes").empty(),n("ul.order_notes").append(n(e.notes_html).find("li"))),c.unblock(i.$el.find(".wc-backbone-modal-content")),c.block(o,{fadeIn:0}),setTimeout(function(){c.unblock(o)},250),i.closeButton(t)):(window.alert(e.error||wc_composite_admin_order_params.i18n_validation_error),c.unblock(i.$el.find(".wc-backbone-modal-content")))})},populate_form:function(){c.block(i.$el.find(".wc-backbone-modal-content"));var e={action:"woocommerce_configure_composite_order_item",item_id:i._string.item_id,dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:wc_composite_admin_order_params.edit_composite_nonce};n.post(woocommerce_admin_meta_boxes.ajax_url,e,function(e){var t;e.result&&"success"===e.result?((t=i.$el.find("form")).html(e.html),t.sw_select2(),i.$el.find(".composite_component").each(function(){new _(n(this))}),c.unblock(i.$el.find(".wc-backbone-modal-content"))):(window.alert(wc_composite_admin_order_params.i18n_form_error),c.unblock(i.$el.find(".wc-backbone-modal-content")),i.$el.find(".modal-close").trigger("click"))})},get_taxable_address:function(){var e="",t="",o="",i="";return"shipping"===woocommerce_admin_meta_boxes.tax_based_on&&(e=n("#_shipping_country").val(),t=n("#_shipping_state").val(),o=n("#_shipping_postcode").val(),i=n("#_shipping_city").val()),"billing"!==woocommerce_admin_meta_boxes.tax_based_on&&e||(e=n("#_billing_country").val(),t=n("#_billing_state").val(),o=n("#_billing_postcode").val(),i=n("#_billing_city").val()),{country:e,state:t,postcode:o,city:i}},block:function(e,t){t=n.extend({},{message:null,overlayCSS:{background:"#fff",opacity:.6}},t||{});e.block(t)},unblock:function(e){e.unblock()}};"no"===wc_composite_admin_order_params.is_wc_version_gte_3_4&&(c.core={init_tiptip:function(){n("#tiptip_holder").removeAttr("style"),n("#tiptip_arrow").removeAttr("style"),n(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200})},stupidtable:{init:function(){n(".woocommerce_order_items").stupidtable(),n(".woocommerce_order_items").on("aftertablesort",this.add_arrows)},add_arrows:function(e,t){var o=n(this).find("th"),i="asc"===t.direction?"&uarr;":"&darr;",t=t.column;o.find(".wc-arrow").remove(),o.eq(t).append('<span class="wc-arrow">'+i+"</span>")}}}),c.handle_events();var _=function(e){var i=this;this.$selection_el=e.find("select.component_option_select"),this.$view_el=e.find(".component_option_selection_details_wrapper"),this.component_id=e.data("component_data").component_id,this.composite_id=e.data("component_data").composite_id;var t=Backbone.Model.extend({selected_product_data:{product_html:""},initialize:function(){this.set({selected_product:i.$selection_el.val()})},update_selection:function(e){e?this.load_selection_data(e):this.update_selected_product("",{product_html:""})},load_selection_data:function(t){var o=this,e={action:"woocommerce_get_composited_product_data",product_id:t,component_id:i.component_id,composite_id:i.composite_id};n.ajax({type:"POST",url:woocommerce_admin_meta_boxes.ajax_url,data:e,timeout:15e3,dataType:"json",success:function(e){"success"===e.result?(e=e.product_data,o.trigger("selected_product_data_loaded",t,e),o.update_selected_product(t,e)):o.trigger("selected_product_data_load_error",t)},error:function(){o.trigger("selected_product_data_load_error",t)}})},update_selected_product:function(e,t){this.selected_product_data=t,this.set({selected_product:e})},get_selected_product_data:function(){return this.selected_product_data}}),e=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"change:selected_product",this.render),this.listenTo(this.model,"selected_product_data_load_error",this.selection_data_load_error),i.$selection_el.on("change",this.selection_changed)},selection_changed:function(){var e=n(this).val()||"";if(i.selection_model.get("selected_product")===e)return!1;e?(i.selection_view.block(),i.selection_model.update_selection(e)):i.selection_model.update_selection("")},render:function(){i.$view_el.html(this.model.get_selected_product_data().product_html),this.model.get("selected_product")&&this.unblock()},selection_data_load_error:function(){var e=this.model.get("selected_product");window.alert(wc_composite_admin_order_params.i18n_selection_request_timeout),i.$selection_el.val(e).change(),this.unblock()},block:function(){c.block(i.$view_el)},unblock:function(){c.unblock(i.$view_el)}});this.selection_model=new t,this.selection_view=new e({el:i.$view_el,model:i.selection_model})}});